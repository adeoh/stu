<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stu</title>
  <meta name="description" content="Start Page: add links, live edit tiles, drag to reorder, and tweak grouped preferences. All saved locally.">
  <style>
    :root{
      --bg:#000000;           /* app background */
      --panel:#0a0a0a;        /* panels/dialogs */
      --muted:#8a8f98;
      --ring:#2a2a2a;         /* faint gray border */
      --text:#ffffff;
      --radius:10px;          /* rounded */
      --font:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif;
      --tile-min:160px;       /* min tile width (slider) */
      --title-size:16px;      /* tile title font size (slider) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.4 var(--font);background:var(--bg);color:var(--text)}

    /* Grid: auto-fill (no max width) */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tile-min),1fr));gap:12px;padding:18px}

    /* Tile */
    .tile.web-link{position:relative;aspect-ratio:1/1;border-radius:var(--radius);overflow:hidden;border:none;background:#0c0c0c;text-decoration:none;color:inherit;transition:transform .12s ease,filter .12s ease}
    .tile:hover{transform:translateY(-2px);filter:brightness(1.02)}
    .tile[draggable="true"]{cursor:grab}
    .tile.dragging{opacity:.85;cursor:grabbing;outline:2px dashed #3a3a3a}
    .tile .bg{position:absolute;inset:0;background:#111;background-size:cover;background-position:center}
    .tile .content{position:absolute;inset:0;padding:14px;display:flex;flex-direction:column;justify-content:flex-end}
    .titleText{font-weight:700;font-size:var(--title-size);line-height:1.2;word-break:break-word;text-shadow:0 1px 0 rgba(0,0,0,.35)}
    .titleText.hidden{display:none}

    /* Hover controls (SVG icons only) */
    .controls{position:absolute;inset:auto 8px 8px auto;display:flex;gap:6px;opacity:0;pointer-events:none;transition:opacity .12s ease}
    .tile:hover .controls{opacity:1;pointer-events:auto}
    .tile.show-ctrls .controls{opacity:1;pointer-events:auto}
    .iconbtn{border:1px solid var(--ring);background:#0a0a0a;color:#fff;width:28px;height:28px;border-radius:var(--radius);display:grid;place-items:center;cursor:pointer}
    .iconbtn:hover{border-color:#3a3a3a}
    .controls, .controls *{-webkit-user-drag:none;user-drag:none}

    .empty{color:var(--muted);text-align:center;padding:40px 18px}

    /* Floating buttons */
    .fab{position:fixed;right:22px;z-index:10;width:56px;height:56px;border-radius:var(--radius);border:none;background:transparent;color:#fff;display:grid;place-items:center;font-size:26px;line-height:0;cursor:pointer}
    #fab{bottom:22px}
    #prefsBtn{bottom:90px;font-size:20px}

    /* Sheets (composer & prefs) */
    .sheet{position:fixed;right:22px;z-index:10;max-width:220px;width:min(560px,calc(100vw - 44px));background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);padding:12px;opacity:0;visibility:hidden;transform:scale(.98);transition:opacity .14s ease,transform .14s ease,visibility .14s ease}
    .sheet.open{opacity:1;visibility:visible;transform:scale(1)}
    #composer{bottom:90px}
    #prefs{bottom:160px}

    /* Inputs & buttons */
    input[type=url],input[type=text],input[type=color],input[type=range],select{flex:1;min-width:0;padding:12px;border-radius:var(--radius);border:1px solid var(--ring);background:#0e0e0e;color:var(--text);outline:none}
    input[type=color]{padding:0;height:42px;width:42px}
    input[type=range]{padding:6px}
    input[type=file]{padding:.5rem;border-radius:var(--radius);border:1px solid var(--ring);background:#0e0e0e;color:var(--text)}
    .btn{border:1px solid var(--ring);background:#0a0a0a;color:#fff;padding:11px 14px;border-radius:var(--radius);font-weight:600;cursor:pointer}
    .btn:hover{border-color:#3a3a3a}

    /* Inline tile editor — compact, live */
    .editor{position:absolute;bottom:8px;left:8px;padding:6px;border:none;border-radius:10px;background:#111;display:flex;gap:8px;align-items:center;flex-wrap:wrap;width:max-content;max-width:calc(100% - 16px)}
    .editor .group{display:flex;align-items:center;gap:6px;background:transparent;border:none;padding:0;flex-wrap:wrap}
    .editor input[type=file]{display:block}

    /* Preferences — vertical labels + accordion styling per spec */
    #prefsForm{display:flex;flex-direction:column;gap:7px}
    #prefsForm > details{background:#0c0c0c}
    #prefsForm > details:not(:last-of-type){border-bottom:2px solid var(--ring)}
    summary{list-style:none;cursor:pointer;padding:.75rem;display:flex;align-items:center;gap:10px;font-weight:700}
    summary::-webkit-details-marker{display:none}
    /* + / – icons */
    details > summary::before{content:"+";display:inline-block;width:1em;text-align:center;margin-right:2px}
    details[open] > summary::before{content:"–"}

    .group-body{padding:12px;display:flex;flex-direction:column;gap:1rem}
    .field{display:flex;flex-direction:column;gap:6px}
    .field > label{font-size:12px;color:#bbb}

    /* Toggle */
    .toggle{position:relative;display:inline-flex;align-items:center;width:44px;height:26px;border-radius:999px;border:1px solid var(--ring);background:#1a1a1a;cursor:pointer}
    .toggle input{position:absolute;opacity:0;width:0;height:0}
    .toggle .track{position:absolute;inset:0;border-radius:999px}
    .toggle .thumb{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform .15s ease}
    .toggle input:checked ~ .thumb{transform:translateX(18px)}
    .toggle input:checked ~ .track{background:#111;border-color:#3a3a3a}

    /* Lock mode */
    body.locked .tile .controls{opacity:0 !important; pointer-events:none !important}
    body.locked .tile[draggable="true"]{cursor:default}
    body.locked .tile.dragging{opacity:1; outline:none}

    /* Under 320px: stack grid vertically */
    @media(max-width:320px){.grid{grid-auto-flow:row;grid-auto-columns:initial;overflow-x:visible;grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="emptyState" class="empty" hidden>No links yet. Tap ( + ) to add.</div>
  </main>

  <!-- Floating Add & Prefs Buttons -->
  <button id="fab" class="fab" aria-label="Add link" aria-expanded="false" title="Add a link">＋</button>
  <button id="prefsBtn" class="fab" aria-label="Preferences" aria-expanded="false" title="Preferences">⚙︎</button>

  <!-- Add link sheet -->
  <div id="composer" class="sheet" role="dialog" aria-modal="true">
    <form id="composerForm" autocomplete="off" style="display:flex;gap:10px;align-items:center">
      <input id="urlInput" type="url" placeholder="https://example.com" required />
      <button id="addBtn" class="btn" type="submit">Add</button>
    </form>
  </div>

  <!-- Preferences sheet (grouped + vertical labels + accordion) -->
  <div id="prefs" class="sheet" role="dialog" aria-modal="true">
    <form id="prefsForm" autocomplete="off">

      <details id="grpGeneral" open>
        <summary>General</summary>
        <div class="group-body">
          <div class="field">
            <label for="optLock">Lock</label>
            <label class="toggle" title="Lock layout">
              <input id="optLock" type="checkbox" />
              <span class="track"></span><span class="thumb"></span>
            </label>
          </div>
          <div class="field">
            <label for="optBgColor">Background Color</label>
            <input id="optBgColor" type="color" value="#000000" />
          </div>
          <div class="field">
            <label for="optBgFile">Background Image</label>
            <!-- Visible native file input here (as requested) -->
            <input id="optBgFile" type="file" accept="image/*" />
          </div>
        </div>
      </details>

      <details id="grpStyle">
        <summary>Style</summary>
        <div class="group-body">
          <div class="field">
            <label for="optShowTitles">Show Titles</label>
            <label class="toggle" title="Show titles">
              <input id="optShowTitles" type="checkbox" checked />
              <span class="track"></span><span class="thumb"></span>
            </label>
          </div>
          <div class="field">
            <label for="optTileWidth">Link Width</label>
            <input id="optTileWidth" type="range" min="120" max="320" step="4" />
          </div>
          <div class="field">
            <label for="optTitleSize">Title Size</label>
            <input id="optTitleSize" type="range" min="12" max="28" step="1" />
          </div>
          <div class="field">
            <label for="optRadius">Border Radius</label>
            <input id="optRadius" type="range" min="4" max="24" step="1" />
          </div>
          <div class="field">
            <label for="optFont">Font</label>
            <input id="optFont" type="text" placeholder="e.g. Inter, system-ui" />
          </div>
        </div>
      </details>

      <details id="grpExport">
        <summary>Export / Import</summary>
        <div class="group-body">
          <div class="field" style="gap:8px">
            <label class="sr-only" for="importFile" hidden>Import file</label>
            <!-- Hide native file input; use buttons only here -->
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="exportBtn" class="btn" type="button">Export Settings</button>
              <button id="importBtn" class="btn" type="button">Import Settings</button>
            </div>
          </div>
        </div>
      </details>

    </form>
  </div>

  <template id="tileTemplate">
    <a class="tile web-link" target="_blank" rel="noopener noreferrer" draggable="true">
      <div class="bg"></div>
      <div class="content"><div class="titleText"></div></div>
      <div class="controls">
        <button class="iconbtn" type="button" data-action="edit" title="Edit" aria-label="Edit">
          <!-- Three dots icon -->
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
        </button>
        <button class="iconbtn" type="button" data-action="remove" title="Remove" aria-label="Remove">
          <!-- Trash icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
        </button>
      </div>
    </a>
  </template>

  <!-- Editor: one responsive group; color box + image upload; live; delayed close on mouseleave -->
  <template id="editorTemplate">
    <div class="editor" role="group" aria-label="Tile settings">
      <div class="group" title="Tile settings">
        <input class="edColor" type="color" aria-label="Background color" />
        <input class="edImgFile" type="file" accept="image/*" aria-label="Upload background image" />
      </div>
    </div>
  </template>

  <script>
    // —— Utilities ——
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    function normalizeUrl(value){ let v=(value||'').trim(); if(!v) throw new Error('Empty URL'); if(!/^https?:\/\//i.test(v)) v='https://'+v; return new URL(v).href; }
    function domainLabelFrom(url){ const host=new URL(url).hostname.replace(/^www\./i,''); if(/\.com$/i.test(host)){ const parts=host.replace(/\.com$/i,'').split('.'); return parts[parts.length-1]; } return host.split('.')[0]; }

    // —— IndexedDB helpers for images ——
    const DB_NAME = 'stu-db';
    const DB_VERSION = 1;
    const IMG_STORE = 'images';
    let dbPromise = null;
    function openDB(){
      if(dbPromise) return dbPromise;
      dbPromise = new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(IMG_STORE)) db.createObjectStore(IMG_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      return dbPromise;
    }
    async function idbPutImage(key, blob){ const db = await openDB(); return new Promise((res, rej)=>{ const tx=db.transaction(IMG_STORE,'readwrite'); tx.objectStore(IMG_STORE).put(blob, key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    async function idbGetImage(key){ const db = await openDB(); return new Promise((res, rej)=>{ const tx=db.transaction(IMG_STORE,'readonly'); const rq = tx.objectStore(IMG_STORE).get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error); }); }
    async function idbDeleteImage(key){ const db = await openDB(); return new Promise((res, rej)=>{ const tx=db.transaction(IMG_STORE,'readwrite'); tx.objectStore(IMG_STORE).delete(key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    const imageURLCache = new Map(); // key -> objectURL
    async function getImageURLForKey(key){ if(!key) return null; if(imageURLCache.has(key)) return imageURLCache.get(key); const blob = await idbGetImage(key); if(!blob) return null; const url = URL.createObjectURL(blob); imageURLCache.set(key, url); return url; }
    function revokeImageURL(key){ const url = imageURLCache.get(key); if(url){ URL.revokeObjectURL(url); imageURLCache.delete(key); } }
    function dataURLToBlob(dataUrl){ try{ const [head, b64] = dataUrl.split(','); const m = /data:(.*?);base64/.exec(head); const mime = m ? m[1] : 'application/octet-stream'; const bin = atob(b64||''); const len = bin.length; const bytes = new Uint8Array(len); for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i); return new Blob([bytes], {type:mime}); }catch{ return null; } }

    // —— State ——
    const STORE_KEY='stu:items:v2';
    const PREFS_KEY='stu:prefs:v2';
    /** @type {Array<{id:string,url:string,title:string,color:string,bgImg:string|null,created:number}>} */
    let items=[];
    let prefs={ lock:false, hideTitles:false, bg:'#000000', bgImgData:null, bgImgKey:null, font:'', tileMin:160, titleSize:16, radius:10 };

    function load(){ try{items=JSON.parse(localStorage.getItem(STORE_KEY)||'[]')}catch{items=[]} try{prefs=Object.assign(prefs, JSON.parse(localStorage.getItem(PREFS_KEY)||'{}'))}catch{} }
    function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(items)); }
    function savePrefs(){ localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }
    function uid(){ return Math.random().toString(36).slice(2,10) }

    // —— Render ——
    const grid=$('#grid'); const empty=$('#emptyState'); const tpl=$('#tileTemplate'); const edTpl=$('#editorTemplate');

    function paintTileDOM(tileEl, it){
      const bg=$('.bg',tileEl); const titleEl=$('.titleText',tileEl);
      bg.style.backgroundColor = it.color || '#111';
      // Reset image first
      bg.style.backgroundImage = 'none';
      // Legacy inline data URL support
      if(it.bgImg){ bg.style.backgroundImage = `url(${it.bgImg})`; }
      // New IDB-backed image
      else if(it.imgKey){
        const key = it.imgKey;
        // Mark current key on element to avoid race conditions
        bg.dataset.key = key;
        getImageURLForKey(key).then(url => { if(url && bg.dataset.key===key){ bg.style.backgroundImage = `url(${url})`; } });
      }
      titleEl.textContent = it.title?.trim() || domainLabelFrom(it.url);
      titleEl.classList.toggle('hidden', !!prefs.hideTitles);
    }

    function render(){
      grid.innerHTML=''; empty.hidden = items.length!==0;
      for(const it of items){
        const node=tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id = it.id; node.href = it.url;
        paintTileDOM(node, it);

        const editBtn = $('[data-action="edit"]', node);
        const removeBtn = $('[data-action="remove"]', node);
        editBtn.setAttribute('draggable','false'); removeBtn.setAttribute('draggable','false');
        editBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); if(prefs.lock) return; openEditor(node, it.id); });
        removeBtn.addEventListener('click', async (e)=>{ e.preventDefault(); e.stopPropagation(); const key = `tile:${it.id}`; revokeImageURL(key); try{ await idbDeleteImage(key); }catch{} items = items.filter(x=>x.id!==it.id); save(); render(); });

        node.addEventListener('click', (e)=>{ if(node.classList.contains('interacting')) e.preventDefault(); });

        node.setAttribute('draggable', String(!prefs.lock));
        node.addEventListener('dragstart', (e)=>{ if(prefs.lock){ e.preventDefault(); return; } node.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', it.id); });
        node.addEventListener('dragend', ()=>{ node.classList.remove('dragging'); });

        grid.appendChild(node);
      }
    }

    function openEditor(tileEl, id){
      if($('.editor', tileEl)) return;
      const it = items.find(x=>x.id===id); if(!it) return;
      const editor = edTpl.content.firstElementChild.cloneNode(true);
      const edColor = $('.edColor', editor);
      const edImgFile = $('.edImgFile', editor);

      edColor.value = it.color || '#222222';
      edColor.addEventListener('input', ()=>{ it.color = edColor.value || it.color; /* do not clear existing image; allow overlay color */ save(); paintTileDOM(tileEl, it); });

      edImgFile.addEventListener('change', async ()=>{ const f=edImgFile.files && edImgFile.files[0]; if(!f) return; const key = `tile:${id}`; revokeImageURL(key); imageURLCache.set(key, URL.createObjectURL(f)); await idbPutImage(key, f); it.imgKey = key; it.bgImg = null; save(); paintTileDOM(tileEl, it); });

      let closeTimer=null;
      const scheduleClose = ()=>{ clearTimeout(closeTimer); closeTimer = setTimeout(()=>{ editor.remove(); tileEl.classList.remove('interacting'); }, 1000); };
      const cancelClose = ()=>{ clearTimeout(closeTimer); };
      editor.addEventListener('mouseleave', scheduleClose);
      editor.addEventListener('mouseenter', cancelClose);

      const outside = (e)=>{ if(!tileEl.contains(e.target)){ editor.remove(); tileEl.classList.remove('interacting'); document.removeEventListener('pointerdown', outside, true); } };
      document.addEventListener('pointerdown', outside, true);

      tileEl.appendChild(editor);
      tileEl.classList.add('interacting');
      editor.addEventListener('click', (e)=> e.stopPropagation(), true);
    }

    // —— Add flow ——
    const fab=$('#fab'); const composer=$('#composer'); const form=$('#composerForm'); const urlInput=$('#urlInput');
    function toggleSheet(el, force){ const open = force ?? !el.classList.contains('open'); el.classList.toggle('open', open); return open; }
    fab.addEventListener('click', ()=>{ const open = toggleSheet(composer); fab.setAttribute('aria-expanded', String(open)); fab.textContent = open ? '×' : '＋'; if(open){ setTimeout(()=> urlInput.focus(), 50); } });

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      let url; try{ url = normalizeUrl(urlInput.value) }catch{ return alert('Please enter a valid URL.'); }
      const it = { id:uid(), url, title:domainLabelFrom(url), color:'#222222', bgImg:null, created:Date.now() };
      items.unshift(it); save(); render(); form.reset(); toggleSheet(composer,false); fab.textContent='＋';
    });

    // —— Drag reorder (grid-level handlers) ——
    const gridEl = grid; // alias for listeners below
    gridEl.addEventListener('dragover', (e)=>{ if(prefs.lock) return; e.preventDefault(); });
    gridEl.addEventListener('drop', (e)=>{
      if(prefs.lock) return; e.preventDefault(); const fromId = e.dataTransfer.getData('text/plain'); const toTile = e.target.closest('.tile'); if(!fromId || !toTile) return; const toId = toTile.dataset.id; if(!toId || fromId===toId) return;
      const fromIdx = items.findIndex(x=>x.id===fromId); const toIdx = items.findIndex(x=>x.id===toId);
      if(fromIdx<0 || toIdx<0) return; const [moved] = items.splice(fromIdx,1); items.splice(toIdx,0,moved); save(); render();
    });

    // —— Preferences (accordion + groups) ——
    const prefsBtn=$('#prefsBtn'); const prefsSheet=$('#prefs');
    const optLock=$('#optLock');
    const optShowTitles=$('#optShowTitles');
    const optBgColor=$('#optBgColor'); const optBgFile=$('#optBgFile');
    const optTileWidth=$('#optTileWidth'); const optTitleSize=$('#optTitleSize'); const optRadius=$('#optRadius');
    const optFont=$('#optFont');
    const exportBtn=$('#exportBtn'); const importBtn=$('#importBtn'); const importFile=$('#importFile');

    let appBgKey = null; // track to revoke
    async function applyPrefsBg(){
      const imgKey = prefs.bgImgKey || null;
      const imgData = prefs.bgImgData || '';
      // Revoke previous URL if switching
      if(appBgKey && appBgKey!==imgKey){ revokeImageURL(appBgKey); appBgKey = null; }
      if(imgKey){
        appBgKey = imgKey;
        const url = await getImageURLForKey(imgKey);
        document.body.style.backgroundImage = url ? `url(${url})` : 'none';
        if(url){ document.body.style.backgroundSize='cover'; document.body.style.backgroundPosition='center'; }
        return;
      }
      // Legacy inline image support
      document.body.style.backgroundImage = imgData ? `url(${imgData})` : 'none';
      if(imgData){ document.body.style.backgroundSize='cover'; document.body.style.backgroundPosition='center'; }
    }

    function applyPrefsToDOM(){
      document.documentElement.style.setProperty('--bg', prefs.bg || '#000000');
      document.documentElement.style.setProperty('--font', prefs.font || 'system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif');
      document.documentElement.style.setProperty('--tile-min', `${prefs.tileMin||160}px`);
      document.documentElement.style.setProperty('--title-size', `${prefs.titleSize||16}px`);
      document.documentElement.style.setProperty('--radius', `${prefs.radius||10}px`);
      document.body.classList.toggle('locked', !!prefs.lock);
      // Apply background image (async safe)
      applyPrefsBg();
      $$('.titleText').forEach(t=> t.classList.toggle('hidden', !!prefs.hideTitles));
      render();
    }

    prefsBtn.addEventListener('click', ()=>{ const open = toggleSheet(prefsSheet); prefsBtn.setAttribute('aria-expanded', String(open)); if(open){
      optLock.checked=!!prefs.lock;
      optShowTitles.checked = !prefs.hideTitles;
      optBgColor.value=prefs.bg || '#000000';
      optTileWidth.value=String(prefs.tileMin||160);
      optTitleSize.value=String(prefs.titleSize||16);
      optRadius.value=String(prefs.radius||10);
      optFont.value=prefs.font || '';
    }});

    // Close sheets when clicking outside
    document.addEventListener('click', (e)=>{
      if(composer.classList.contains('open')){
        const within = composer.contains(e.target) || fab.contains(e.target);
        if(!within){ toggleSheet(composer,false); fab.textContent='＋'; }
      }
      if(prefsSheet.classList.contains('open')){
        const within2 = prefsSheet.contains(e.target) || prefsBtn.contains(e.target);
        if(!within2){ toggleSheet(prefsSheet,false); prefsBtn.setAttribute('aria-expanded','false'); }
      }
    });

    // Accordion behaviour: open one, close others
    const accordions = $$('#prefsForm > details');
    accordions.forEach(d => {
      d.addEventListener('toggle', ()=>{
        if(d.open){ accordions.forEach(other => { if(other!==d) other.open=false; }); }
      });
    });

    // General
    optLock.addEventListener('change', ()=>{ prefs.lock = optLock.checked; savePrefs(); applyPrefsToDOM(); });
    optBgColor.addEventListener('input', ()=>{ prefs.bg = optBgColor.value || '#000000'; savePrefs(); applyPrefsToDOM(); });
    optBgFile.addEventListener('change', async ()=>{ const f=optBgFile.files && optBgFile.files[0]; if(!f) return; const key='prefs:bg'; revokeImageURL(key); imageURLCache.set(key, URL.createObjectURL(f)); await idbPutImage(key, f); prefs.bgImgKey = key; prefs.bgImgData = null; savePrefs(); applyPrefsToDOM(); });

    // Style
    optShowTitles.addEventListener('change', ()=>{ prefs.hideTitles = !optShowTitles.checked; savePrefs(); applyPrefsToDOM(); });
    optTileWidth.addEventListener('input', ()=>{ const v = Math.max(120, Math.min(320, +optTileWidth.value||160)); prefs.tileMin = v; savePrefs(); applyPrefsToDOM(); });
    optTitleSize.addEventListener('input', ()=>{ const v = Math.max(12, Math.min(28, +optTitleSize.value||16)); prefs.titleSize = v; savePrefs(); applyPrefsToDOM(); });
    optRadius.addEventListener('input', ()=>{ const v = Math.max(4, Math.min(24, +optRadius.value||10)); prefs.radius = v; savePrefs(); applyPrefsToDOM(); });
    const applyFontNow = ()=>{ prefs.font = (optFont.value||'').trim(); savePrefs(); applyPrefsToDOM(); };
    optFont.addEventListener('change', applyFontNow);
    optFont.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); optFont.blur(); }});

    // Export / Import (native input hidden here; buttons group triggers it)
    function blobToDataURL(blob){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result)); r.onerror=()=>rej(r.error); r.readAsDataURL(blob); }); }
    exportBtn.addEventListener('click', async ()=>{
      const images = {};
      // Collect tile images
      for(const it of items){ if(it.imgKey){ try{ const b = await idbGetImage(it.imgKey); if(b){ images[it.imgKey] = await blobToDataURL(b); } }catch{} } }
      // Collect prefs background image
      if(prefs.bgImgKey){ try{ const b = await idbGetImage(prefs.bgImgKey); if(b){ images[prefs.bgImgKey] = await blobToDataURL(b); } }catch{} }
      const data = { version:'stu-v2', exportedAt: new Date().toISOString(), items, prefs, images };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='stu-settings.json'; a.click(); URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', ()=>{ const f=importFile.files && importFile.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ (async()=>{ try{ const data=JSON.parse(String(r.result)); if(!confirm('Import will replace current items and preferences. Continue?')) return; if(Array.isArray(data.items)) items=data.items; if(data.prefs && typeof data.prefs==='object') prefs=Object.assign(prefs, data.prefs);
        // Rehydrate images from export
        if(data.images && typeof data.images==='object'){
          for(const [key, dataUrl] of Object.entries(data.images)){
            const blob = dataURLToBlob(String(dataUrl)); if(blob) await idbPutImage(key, blob);
          }
        }
        // Legacy fields migration after import
        await migrateLegacyImages();
        save(); savePrefs(); applyPrefsToDOM();
      }catch(err){ console.error(err); alert('Invalid JSON file.'); } })(); }; r.readAsText(f); });

    // —— Migration (legacy inline images to IDB) ——
    async function migrateLegacyImages(){
      let changed = false;
      for(const it of items){ if(it && typeof it.bgImg==='string' && it.bgImg.startsWith('data:')){ const blob = dataURLToBlob(it.bgImg); if(blob){ const key = `tile:${it.id}`; await idbPutImage(key, blob); it.imgKey = key; it.bgImg = null; changed = true; } } }
      if(prefs && typeof prefs.bgImgData==='string' && prefs.bgImgData.startsWith('data:')){ const blob = dataURLToBlob(prefs.bgImgData); if(blob){ const key='prefs:bg'; await idbPutImage(key, blob); prefs.bgImgKey = key; prefs.bgImgData = null; changed = true; } }
      if(changed){ save(); savePrefs(); }
    }

    // —— Init ——
    (async function init(){
      load();
      await migrateLegacyImages();
      applyPrefsToDOM();
    })();
  </script>
</body>
</html>
